server {
    listen 80;
    server_name _;

    # Static files (Vite build output)
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Note: COOP/COEP headers omitted — they enable SharedArrayBuffer
        # (multi-threaded DuckDB-WASM) but block cross-origin tile/font fetches
        # from OpenFreeMap. DuckDB-WASM falls back to single-threaded mode,
        # which is fine for this dataset size.
    }

    # Proxy: Feature API → FastAPI + DuckDB
    location /api/ {
        proxy_pass http://lakehouse-api:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 500m;
        proxy_read_timeout 300s;
    }

    # Proxy: S3 API → Garage
    location /s3/ {
        proxy_pass http://garage:3900/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # Allow large range requests for Parquet files
        proxy_buffering off;
        proxy_request_buffering off;
        client_max_body_size 0;
    }

    # Proxy: Iceberg REST Catalog → LakeKeeper
    location /catalog/ {
        proxy_pass http://lakekeeper:8181/catalog/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Redirect /ogc (no trailing slash) → /ogc/ so pygeoapi proxy handles it.
    # ArcPro follows links like http://host:3000/ogc which miss location /ogc/.
    location = /ogc {
        return 301 $scheme://$http_host/ogc/$is_args$args;
    }

    # Proxy: OGC API Features → pygeoapi
    location /ogc/ {
        proxy_pass http://pygeoapi:5000/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_buffering off;
        proxy_read_timeout 120s;

        # Force uncompressed responses from pygeoapi so sub_filter can rewrite URLs.
        # nginx will re-compress for the client via gzip on; if enabled globally.
        proxy_set_header Accept-Encoding "";

        # Dynamically rewrite pygeoapi's internal URLs to match the client's host.
        # pygeoapi generates links using its configured server.url (localhost:3000).
        # nginx replaces that with the actual request host so links work from any
        # client — localhost, LAN IP, EC2 public IP — without config changes.
        sub_filter_types *;
        sub_filter_once off;
        sub_filter 'http://localhost:3000' '$scheme://$http_host';
    }

    # Proxy: Esri GeoServices REST → geoservices
    location /esri/ {
        proxy_pass http://geoservices:8001/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_buffering off;
        proxy_read_timeout 120s;
    }
}
